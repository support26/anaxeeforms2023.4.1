<!--
Copyright 2023 ODK Central Developers
See the NOTICE file at the top-level directory of this distribution and at
https://github.com/getodk/central-frontend/blob/master/NOTICE.

This file is part of ODK Central. It is subject to the license terms in
the LICENSE file found in the top-level directory of this distribution and at
https://www.apache.org/licenses/LICENSE-2.0. No part of ODK Central,
including this file, may be copied, modified, propagated, or distributed
except according to the terms contained in the LICENSE file.
-->

<template>
  <summary-item id="connection-to-forms" icon="magic-wand">
    <template #heading>
      {{ propertiesByForm.length }}
    </template>
    <template #body>
      <p>{{ $tc('formsCreateEntities', propertiesByForm.length) }}</p>
      <div class="div">
        <expandable-row v-for="(form) in propertiesByForm" :key="form.xmlFormId">
          <template #title>
            <div class="form-name">
              <router-link :to="publishedFormPath(projectId, form.xmlFormId)" v-tooltip.text>{{ form.name }}</router-link>
            </div>
          </template>
          <template #caption>
            {{ $tcn('common.propertiesCount', totalProperties, { inform: $n(form.properties.length, 'default') }) }}
          </template>
          <template #details>
            <span v-for="(property, index) in form.properties" :key="property" class="property-list">
              {{ property }}<template v-if="index < form.properties.length - 1">{{
                $t('common.punctuations.comma')
              }}<sentence-separator/></template>
            </span>
            <span v-if="form.properties.length === 0" class="no-properties">{{ $t('entity.noProperties') }}</span>
          </template>
        </expandable-row>
      </div>
    </template>
  </summary-item>
</template>

<script>
import SummaryItem from '../../summary-item.vue';
import ExpandableRow from '../../expandable-row.vue';
import SentenceSeparator from '../../sentence-separator.vue';

import useRoutes from '../../../composables/routes';

export default {
  name: 'ConnectionToForms',
  components: {
    SentenceSeparator,
    SummaryItem,
    ExpandableRow
  },
  props: {
    properties: {
      type: Array,
      required: true
    },
    sourceForms: {
      type: Array,
      required: true
    },
    projectId: {
      type: String,
      required: true
    }
  },
  setup() {
    const { publishedFormPath } = useRoutes();
    return { publishedFormPath };
  },
  computed: {
    totalProperties() {
      return this.properties.length;
    },
    propertiesByForm() {
      const formMap = new Map(this.sourceForms.map(f => ([f.xmlFormId, { ...f, projectId: this.projectId, properties: [] }])));

      for (const p of this.properties) {
        for (const f of p.forms) {
          const form = formMap.get(f.xmlFormId);
          form.properties.push(p.name);
        }
      }

      return Array.from(formMap.values());
    }
  }
};
</script>

<style lang="scss">
@import '../../../assets/scss/mixins';

#connection-to-forms{
  margin-bottom: 10px;

  .expandable-row {
    border-bottom: 1px solid #ddd;
  }

  .expandable-row:last-child {
    border-bottom: none;
  }

  .title-cell{
    max-width: calc(100% - 180px);

    .form-name {
      @include text-overflow-ellipsis;
    }
  }

  a, .expandable-row button {
    font-size: 16px;
  }

  .property-list {
    hyphens: auto;
    overflow-wrap: break-word;
  }

  .no-properties {
    font-style: italic;
  }
}
</style>

<i18n lang="json5">
  {
    "en": {
      // Number of form(s) is shown separately above this text
      "formsCreateEntities": "Form creates Entities in this Entity List | Forms create Entities in this Entity List"
    }
  }
  </i18n>

<!-- Autogenerated by destructure.js -->
<i18n>
{
  "es": {
    "formsCreateEntities": "El formulario crea entidades en esta lista de entidades | Los formularios crean Entidades en esta Lista de Entidades | Los formularios crean Entidades en esta Lista de Entidades"
  },
  "fr": {
    "formsCreateEntities": "Formulaire créant des entités dans cette liste | Formulaires créant des entités dans cette liste | Formulaires créant des entités dans cette liste"
  },
  "it": {
    "formsCreateEntities": "Il formulario crea Entità nella Lista Entità | Il formulario crea Entità nella Lista Entità | Il formulario crea Entità nella Lista Entità"
  }
}
</i18n>
